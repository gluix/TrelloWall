<html>
<head>
  <title>Trellowall</title>  
  <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script src="https://api.trello.com/1/client.js?key=3d8b8a5a1dbdc837c422f6dc12a0a6e8"></script>      
  <script src="res/jquery.masonry.min.js"></script> 
  <script src="res/trellowall.js"></script>  
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>  
  
  <!--refresh timer -->   
  <script type='text/javascript'>
	$(document).ready(function() {
		var refresh = $.urlParam('refresh');
		if(!refresh)
		{
			refresh = 60;
		}
		setInterval("onAuthorize()", refresh * 1000);
	});
  </script>  
  
  <!-- use the original trello css -->
  <link rel="stylesheet" href="https://d2k1ftgv7pobq7.cloudfront.net/css/d9fb6ddfd29393ad6d4bccbbfe5c1ec2/core.css" /> 
  <link rel="stylesheet" type="text/css" href="res/customize.css">
  
<script type='text/javascript'>//<![CDATA[ 
function onAuthorize() {
    updateLoggedIn();
    $("#output").empty();
    
	var renderedMembers = [];
	
	var boardHash = {};
	var listHash = {};
	
	
	var organizationFilter = $.urlParam('board_organization');
	var usernameFilter = $.urlParam('card_members_username');
	var labelFilter = $.urlParam('card_labels_name');
	
	var listIdFilter = $.urlParam('list_id');
	var listNameFilter = $.urlParam('list_name');
		
	var boardIdFilter = $.urlParam('board_id');
	var boardNameFilter = $.urlParam('board_name');
		
	var minVoteFilter = $.urlParam('minVoteFilter');

	 
	var $membersContent = $("#members-content")    
	$membersContent.empty();
	
    Trello.members.get("me", function(member){
        $("#fullName").text(member.fullName);
    		
		var $loading = $("<div>")
			.addClass("window-module-title")
            .text("loading boards...")		
            .appendTo("#output");
		console.log("loading boards...");
		
		var $boards = $("<div>")
            .appendTo("#output");
		
		var boardUrl = "";
		if(organizationFilter)
			boardUrl = "organizations/" + organizationFilter + "/boards";			
		else
			boardUrl = "members/me/boards";
				
		Trello.get(boardUrl, function(boards) {			
			$loading.text("loading lists...");
			console.log("loading lists...");
            $.each(boards, function(ix, board) {
				boardHash[board.id] = board;
			
				var $boardModule = $("<div>") 
				.attr({id: "board_" + board.id})				
				.addClass("window-module")
				.appendTo($boards);	
				$boardModule.hide();
								
				var $boardTitle = $("<div>")                
				.addClass("window-module-title")
				.addClass("board-module-title")
				.appendTo($boardModule)
				
				var $boardLink = $("<a>")
				.attr({href: board.url, target: "trello"})
				.addClass("card")
				.text(board.name)
				.appendTo($boardTitle);	
				
				var $boardCards = $("<div>") 
				.attr({id: "boardcards_" + board.id})				
				.addClass("float-cards clearfix")
				.appendTo($boardModule);
								
				Trello.get("/boards/" + board.id + "/lists", function(lists) {				
					$.each(lists, function(ix, list) {						
						listHash[list.id] = list;				
					});  
				});
			});

			$loading.text("loading cards...");
			console.log("loading cards...");
			
			var cardsUrl = "members/me/cards?members=true";			
			Trello.get(cardsUrl, function(cards) {
				$loading.text("check/render cards...");
				console.log("check/render cards");
				$.each(cards, function(ix, card) {	
					var isValidCard = true;
					
					if(isValidCard && labelFilter)
					{
						isValidCard = false;
						for(i=0;i<card.labels.length;i++)
						{									
							if(card.labels[i].name == labelFilter)
							{										
								isValidCard = true;												
							}
						}
					}
																	
					if(isValidCard && usernameFilter)		
					{		
						isValidCard = false;								
						for(i=0;i<card.members.length;i++)
						{
							if(card.members[i].username == usernameFilter)
							{
								isValidCard = true;										
							}
						}
					}
											
					if(isValidCard && listNameFilter)		
					{		
						isValidCard = false;								
						if(listHash[card.idList].name == listNameFilter)
						{
							isValidCard = true;										
						}
					}
					
					if(isValidCard && boardNameFilter)		
					{		
						isValidCard = false;								
						if(boardHash[card.idBoard].name == boardNameFilter)
						{
							isValidCard = true;										
						}
					}
					
					if(isValidCard && listIdFilter)		
					{		
						isValidCard = false;								
						if(card.idList == listIdFilter)
						{
							isValidCard = true;										
						}
					}
					
					if(isValidCard && boardIdFilter)		
					{		
						isValidCard = false;								
						if(card.idBoard == boardIdFilter)
						{
							isValidCard = true;										
						}
					}
					
					if(isValidCard && minVoteFilter)		
					{		
						isValidCard = false;								
						if(card.badges.votes >= minVoteFilter)
						{
							isValidCard = true;										
						}
					}					
					if(isValidCard)
					{				
						$("#board_" + card.idBoard).show();

						var $cardContainer = $("<div>")								
						.addClass("list-card-container-customize")								
						.appendTo("#boardcards_" + card.idBoard);		
						
						var $card = $("<div>")								
						.addClass("list-card clearfix")								
						.appendTo($cardContainer);	
						
						var $cardLabels = $("<div>")								
						.addClass("card-labels clearfix")								
						.appendTo($card);	
						
						var $cardLink = $("<a>")	
						.attr({href: card.url, target: "trello", id: "card_" + card.id})								
						.addClass("card-link")	
						.text(card.name)								
						.appendTo($cardLabels);
															
						var $cardList = $("<p>")								
						.addClass("list-card-position quiet")	
						.html("in <strong>" + listHash[card.idList].name + "</strong>")								
						.appendTo($cardLabels);								
		
						var $cardMembers = $("<div>")								
						.addClass("list-card-members")										
						.appendTo($cardLabels);	
						
						for(i=0;i<card.members.length;i++)
						{
							var $cardMember;
							if(card.members[i].avatarHash)
							{
								var avatarUrl = 'https://trello-avatars.s3.amazonaws.com/' + card.members[i].avatarHash + '/30.png';
								$cardMember = $("<img>")
								.attr({src: avatarUrl, alt: card.members[i].fullName})													
								.addClass("useravatar")	
								.css("margin-right", "5px")							
								.appendTo($cardMembers);
								
								
							}
							else
							{
								$cardMember = $("<span>")
								.text(card.members[i].initials)													
								.addClass("userinitials")
								.appendTo($cardMembers);
							}
							
							
							if(($.inArray(card.members[i].username, renderedMembers)) == -1)
							{
								$cardMember.clone().css("margin", "2px 10px 2px 2px").appendTo("#members-content");
								
								var $member = $("<div>")
								.addClass("username")		
								.text(card.members[i].fullName)		
								.appendTo("#members-content");											
								renderedMembers.push(card.members[i].username);
							}
						}
						
						if(card.badges.votes > 0)
						{
							var $cardVotes = $("<div>")								
							.addClass("badge votes voted")									
							.appendTo($cardLabels);	
							
							var $cardVotesIcon = $("<span>")								
							.addClass("app-icon small-icon vote-icon")										
							.appendTo($cardVotes);
							
							var $cardVotesTest = $("<span>")								
							.text("+ " + card.idMembersVoted.length)								
							.appendTo($cardVotes);
						}
					}
				});  
				console.log("done loading");
				
				console.log("start masonry");
				  $('.float-cards').masonry({
					itemSelector : '.list-card-container-customize',
					gutterWidth : 15,										
				  });
				console.log("end masonry");
				
				$loading.hide();
			});			
        });

		
    });

};

function updateLoggedIn() {
    var isLoggedIn = Trello.authorized();
    $("#loggedout").toggle(!isLoggedIn);
    $("#loggedin").toggle(isLoggedIn);        
};
    
function logout() {
    Trello.deauthorize();
    updateLoggedIn();
};

$(window).load(function(){
	$("#loggedout").toggle(true);
	$("#loggedin").toggle(false);  
							  
	Trello.authorize({
		interactive:false,
		success: onAuthorize,
		name: "TrelloWall",
		expiration: "never",		
		persist: true
	});

	$("#connectLink")
	.click(function(){
		Trello.authorize({
			type: "rederict",
			success: onAuthorize,
			name: "TrelloWall",
			expiration: "never",		
			persist: true
		})
	});
		
	$("#disconnect").click(logout);
});//]]>  

</script>
</head>
<body class="page-index  chrome chrome-21 windows extra-large-window fixed-content wide-profile">
	<div id="loggedout">
		<a id="connectLink" href="#">Connect To Trello</a>
	</div>
		
	<div id="loggedin">
		<div id="header">
			Logged in as <span id="fullName"></span> 
			<a id="disconnect" href="#">Log Out</a>
		</div>
		
		<div id="members" class="window-sidebar"> 
			<div id="members-title" class="window-module">
				<div class="window-module-title">
					Members 				
				</div>
				<div id="members-content" class="list-card clearfix">		
				</div>
			</div>
		</div>
		
		<div id="output" class="js-cards-content">
		</div>
		

	</div>  
</body>
</html>